# PRD: Elasticsearch 검색 화면 개선

## 1. 개요

### 1.1 목적
사용자가 Elasticsearch에 인덱싱된 문서를 효과적으로 검색하고, 검색 필드 및 가중치를 동적으로 조정하여 최적의 검색 결과를 얻을 수 있도록 검색 UI를 개선한다.

### 1.2 배경
- 현재 3개 화면 존재: Chat / Parsing 결과 / ES 검색
- ES 검색 화면은 기본적인 검색 기능만 제공
- 필드별 가중치가 하드코딩되어 있어 유연한 검색 테스트가 어려움

### 1.3 목표
- 검색어 입력 시 관련 문서 목록 표시
- 검색 대상 필드를 사용자가 직접 선택 가능
- 각 필드별 가중치를 실시간으로 조정 가능
- 검색 결과의 스코어 기반 랭킹 제공

---

## 2. 사용자 스토리

### 2.1 메인 유저 스토리
```
As a 검색 품질 테스터
I want to 검색 필드와 가중치를 조정하면서 검색을 테스트할 수 있기를
So that 최적의 검색 파라미터를 찾을 수 있다
```

### 2.2 세부 유저 스토리

#### US-1: 검색 실행
- **As a** 사용자
- **I want to** 검색어를 입력하고 검색 버튼을 클릭하면
- **So that** 관련 문서 목록을 볼 수 있다

#### US-2: 필드 선택
- **As a** 검색 테스터
- **I want to** 검색 대상 필드를 체크박스로 선택/해제할 수 있기를
- **So that** 특정 필드만 대상으로 검색을 테스트할 수 있다

#### US-3: 가중치 조정
- **As a** 검색 품질 관리자
- **I want to** 각 필드의 가중치를 슬라이더로 조정할 수 있기를
- **So that** 필드별 중요도를 실시간으로 변경하며 결과를 확인할 수 있다

#### US-4: 검색 결과 확인
- **As a** 사용자
- **I want to** 검색 결과를 랭킹 순으로 보고, 각 문서의 스코어를 확인할 수 있기를
- **So that** 검색 품질을 정량적으로 평가할 수 있다

#### US-5: 검색 설정 저장/불러오기
- **As a** 검색 테스터
- **I want to** 현재 필드 선택 및 가중치 설정을 저장하고 나중에 불러올 수 있기를
- **So that** 반복 테스트 시 매번 설정하지 않아도 된다

---

## 3. 기능 요구사항

### 3.1 검색 입력 영역

#### F-1.1 검색어 입력
- **필수**: 검색어 입력 필드 (텍스트 인풋)
- **필수**: 검색 버튼
- **선택**: 검색어 자동완성 (향후 고려)
- **선택**: 검색 히스토리 (향후 고려)

#### F-1.2 검색 옵션
- **필수**: 페이지 크기 선택 (10, 20, 50, 100)
- **선택**: 정렬 옵션 (관련도/날짜/제목)

### 3.2 필드 선택 영역

#### F-2.1 사용 가능한 필드 목록
**필수 필드** (ES 인덱스에 존재하는 필드):
- `search_text` - 본문 텍스트
- `chunk_summary` - 청크 요약
- `chunk_keywords` - 키워드
- `content` - 원본 콘텐츠
- `chapter` - 챕터명
- `doc_description` - 문서 설명
- `device_name` - 장비명
- `doc_type` - 문서 타입

#### F-2.2 필드 선택 UI
- **필수**: 각 필드별 체크박스 (선택/해제)
- **필수**: 전체 선택/해제 토글
- **선택**: 필드 그룹화 (메타데이터/콘텐츠)

#### F-2.3 필드 설명
- **필수**: 각 필드의 설명 툴팁
- **예시**: "search_text: 문서의 주요 본문 텍스트입니다"

### 3.3 가중치 조정 영역

#### F-3.1 가중치 슬라이더
- **필수**: 선택된 필드만 가중치 슬라이더 표시
- **필수**: 슬라이더 범위: 0.0 ~ 3.0 (0.1 단위)
- **필수**: 현재 값 실시간 표시
- **필수**: 기본값: 1.0

#### F-3.2 가중치 프리셋
- **선택**: 프리셋 버튼
  - "균등 배분" (모든 필드 1.0)
  - "본문 중심" (search_text 2.0, 나머지 0.5)
  - "요약 중심" (chunk_summary 2.0, 나머지 0.5)
  - "메타데이터 중심" (device_name, doc_type 2.0, 나머지 0.5)

#### F-3.3 가중치 초기화
- **필수**: "초기화" 버튼 (모든 가중치를 1.0으로)

### 3.4 검색 결과 영역

#### F-4.1 검색 결과 리스트
- **필수**: 문서 목록 (카드 또는 리스트 형태)
- **필수**: 각 문서 표시 정보:
  - 순위 (1, 2, 3, ...)
  - 문서 제목 (title 또는 doc_id)
  - 스니펫 (일부 본문, 하이라이트)
  - 스코어 (0.00~1.00 또는 절대값)
  - 메타데이터 (device_name, doc_type 등)

#### F-4.2 검색 결과 상세
- **필수**: 문서 클릭 시 상세 내용 표시 (모달 또는 사이드 패널)
- **선택**: 문서 원문 보기
- **선택**: 매칭된 키워드 하이라이트

#### F-4.3 페이지네이션
- **필수**: 이전/다음 페이지 버튼
- **필수**: 페이지 번호 표시
- **필수**: 전체 결과 개수 표시 (예: "총 127개 결과")

#### F-4.4 결과 없음 처리
- **필수**: 검색 결과 0건 시 안내 메시지
- **선택**: 추천 검색어 제안

### 3.5 검색 설정 관리 (선택 사항)

#### F-5.1 설정 저장
- **선택**: "현재 설정 저장" 버튼
- **선택**: 설정 이름 입력 (예: "기본 검색", "정밀 검색")
- **선택**: localStorage에 저장

#### F-5.2 설정 불러오기
- **선택**: 저장된 설정 목록 드롭다운
- **선택**: "불러오기" 버튼

---

## 4. 비기능 요구사항

### 4.1 성능
- **필수**: 검색 응답 시간 < 2초 (일반 쿼리)
- **필수**: 검색 응답 시간 < 5초 (복잡한 쿼리)
- **필수**: UI 반응성: 슬라이더 조작 시 즉시 UI 업데이트

### 4.2 사용성
- **필수**: 모바일 반응형 디자인 (최소 768px 이상)
- **필수**: 키보드 단축키 지원 (Enter로 검색)
- **선택**: 접근성 (ARIA 레이블, 스크린 리더 지원)

### 4.3 호환성
- **필수**: Chrome, Edge, Firefox 최신 버전
- **선택**: Safari 최신 버전

### 4.4 에러 처리
- **필수**: API 에러 시 사용자 친화적 메시지 표시
- **필수**: 네트워크 에러 시 재시도 옵션 제공
- **필수**: 타임아웃 시 명확한 안내

---

## 5. UI/UX 설계

### 5.1 화면 레이아웃

```
┌─────────────────────────────────────────────────────────────────┐
│  Elasticsearch 검색 테스트                          [Chat] [Parsing] [Search] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │ 검색 입력 영역                                           │  │
│  │ ┌───────────────────────────────────────────┐ [검색]  │  │
│  │ │ 검색어를 입력하세요...                        │        │  │
│  │ └───────────────────────────────────────────┘ 페이지크기:│  │
│  │                                              [20 ▼]     │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────┬─────────────────────────────────────────┐│
│  │ 필드 선택 & 가중치│  검색 결과                               ││
│  │                  │  ┌─────────────────────────────────────┐││
│  │ [✓] 전체 선택    │  │ 총 45개 결과                        │││
│  │                  │  └─────────────────────────────────────┘││
│  │ ☑ search_text    │  ┌─────────────────────────────────────┐││
│  │ ━━━◉━━━━ 1.0    │  │ #1  [92%] PM 점검 매뉴얼             │││
│  │                  │  │     PM 예방 점검은 장비의 안정적인...│││
│  │ ☑ chunk_summary  │  │     📄 SOP | 🔧 SUPRA                │││
│  │ ━━◉━━━━━ 0.7    │  └─────────────────────────────────────┘││
│  │                  │  ┌─────────────────────────────────────┐││
│  │ ☑ chunk_keywords │  │ #2  [87%] 설치 가이드                │││
│  │ ━━━◉━━━━ 0.8    │  │     장비 설치 시 다음 절차를 따라... │││
│  │                  │  │     📄 Setup | 🔧 INTEGER PLUS       │││
│  │ ☐ content        │  └─────────────────────────────────────┘││
│  │                  │  ┌─────────────────────────────────────┐││
│  │ ☐ chapter        │  │ #3  [85%] 유지보수 절차              │││
│  │                  │  │     정기 유지보수는 매월...          │││
│  │ ☐ device_name    │  │     📄 Maintenance | 🔧 GENEVA       │││
│  │                  │  └─────────────────────────────────────┘││
│  │ ☐ doc_type       │                                          ││
│  │                  │  [이전] 1 2 3 4 5 [다음]                ││
│  │ ─────────────    │                                          ││
│  │ [프리셋 ▼]       │                                          ││
│  │ [초기화]         │                                          ││
│  │                  │                                          ││
│  │ 쿼리 미리보기:   │                                          ││
│  │ search_text^1.0, │                                          ││
│  │ chunk_summary^0.7│                                          ││
│  └──────────────────┴─────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 컴포넌트 구조

```
SearchPage
├── SearchHeader (검색어 입력, 옵션)
├── SearchControls
│   ├── FieldSelector (필드 선택)
│   ├── WeightSlider (가중치 조정)
│   └── PresetButtons (프리셋)
└── SearchResults
    ├── ResultStats (결과 통계)
    ├── ResultList
    │   └── ResultCard (개별 결과)
    └── Pagination
```

### 5.3 상태 관리

```typescript
interface SearchState {
  query: string;
  selectedFields: string[];
  fieldWeights: Record<string, number>;
  results: SearchResult[];
  total: number;
  page: number;
  pageSize: number;
  loading: boolean;
  error: string | null;
}
```

---

## 6. API 명세

### 6.1 검색 API

**Endpoint**: `GET /api/search`

**Query Parameters**:
```typescript
{
  q: string;                    // 검색어 (필수)
  page?: number;                // 페이지 번호 (기본: 1)
  size?: number;                // 페이지 크기 (기본: 20)
  field_weights?: string;       // 필드 가중치 (예: "search_text^1.0,chunk_summary^0.7")
}
```

**Response**:
```typescript
{
  query: string;
  items: Array<{
    rank: number;
    id: string;
    title: string;
    snippet: string;
    score: number;
    score_display: string;
    metadata: {
      device_name?: string;
      doc_type?: string;
      chapter?: string;
    };
  }>;
  total: number;
  page: number;
  size: number;
  has_next: boolean;
}
```

### 6.2 필드 목록 조회 API (선택 사항)

**Endpoint**: `GET /api/search/fields`

**Response**:
```typescript
{
  fields: Array<{
    name: string;
    label: string;
    description: string;
    type: string;  // "text" | "keyword" | "metadata"
    searchable: boolean;
  }>;
}
```

---

## 7. 개발 우선순위

### Phase 1: MVP (필수 기능)
1. ✅ 검색어 입력 및 검색 실행
2. ✅ 하드코딩된 3개 필드 선택 (search_text, chunk_summary, chunk_keywords)
3. ✅ 필드별 가중치 슬라이더 (0.0~2.0)
4. ✅ 검색 결과 리스트 표시 (스코어 포함)
5. ✅ 페이지네이션

### Phase 2: 필드 확장 (다음 단계)
1. 모든 검색 가능 필드 동적 로드
2. 필드별 체크박스 선택/해제
3. 선택된 필드만 가중치 슬라이더 표시
4. 전체 선택/해제 기능

### Phase 3: 고급 기능 (향후)
1. 가중치 프리셋
2. 설정 저장/불러오기
3. 검색 결과 상세 모달
4. 검색 히스토리
5. 자동완성

---

## 8. 성공 지표

### 8.1 정량적 지표
- 검색 응답 시간 < 2초 달성률 > 95%
- 페이지 로딩 시간 < 1초
- 에러율 < 1%

### 8.2 정성적 지표
- 검색 테스터가 원하는 필드 조합으로 테스트 가능
- 가중치 조정 후 즉시 결과 반영 확인 가능
- 직관적인 UI로 별도 교육 없이 사용 가능

---

## 9. 제약사항 및 가정

### 9.1 제약사항
- 백엔드 API는 이미 구현되어 있음 (`/api/search`)
- Elasticsearch 인덱스 스키마는 변경하지 않음
- 프론트엔드 기술 스택: React + TypeScript + Ant Design

### 9.2 가정
- ES 인덱스에 최소 8개 이상의 searchable 필드 존재
- 평균 검색 결과는 10~100건 범위
- 사용자는 검색 품질 테스트 담당자 (내부 사용자)

---

## 10. 향후 고려사항

1. **고급 검색 기능**
   - Boolean 연산 (AND, OR, NOT)
   - Phrase 검색 ("exact match")
   - Wildcard 검색 (prefix*, *suffix)

2. **필터링**
   - doc_type별 필터
   - device_name별 필터
   - 날짜 범위 필터

3. **시각화**
   - 검색 스코어 분포 차트
   - 필드별 매칭 히트맵

4. **A/B 테스트**
   - 두 가지 가중치 설정 비교
   - 결과 차이 시각화

---

## 부록: 현재 구현 상태

### 현재 파일 위치
- **프론트엔드**: `frontend/src/features/search/pages/search-page.tsx`
- **백엔드 API**: `backend/api/routers/search.py`
- **서비스**: `backend/services/es_search_service.py`

### 현재 구현된 기능
- ✅ 기본 검색 (search_text, chunk_summary, chunk_keywords)
- ✅ 필드별 가중치 슬라이더 (0.0~2.0)
- ✅ 검색 결과 리스트
- ✅ 스코어 표시
- ✅ 초기화 버튼

### 추가 필요 기능
- ❌ 필드 선택 체크박스
- ❌ 동적 필드 로드
- ❌ 추가 필드 지원 (content, chapter, device_name 등)
- ❌ 프리셋 기능
- ❌ 설정 저장/불러오기
